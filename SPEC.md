# Спецификация: Vercel, Supabase, закрытый доступ, Notebook LM

Цели: перенести деплой на Vercel, подключить базу Supabase с invite-only авторизацией (только для членов семьи), обеспечить offline-first синхронизацию; ручная интеграция с Notebook LM как семейной базой знаний через папку «рецепты» в Google Drive; возможность загрузки текстовых рецептов с очисткой и разметкой.

---

## 1. Текущее состояние

- **Деплой:** GitHub Actions → GitHub Pages, `base: '/SemeynoYeda/'` в vite.config.ts.
- **Данные:** только клиент — Dexie (IndexedDB), таблицы: `recipes`, `menus`, `freezer`, `shopping`, `prepPlans`, `cookingSessions`, `chefSettings`. Схема в `src/data/schema.ts`, сиды в `src/data/seedRecipes.ts` и seedMenu.
- **Авторизация:** отсутствует.

---

## 2. Деплой на Vercel

- Подключить репозиторий к Vercel (Vercel Dashboard → Import Project).
- **Build:** `npm run build`, output directory `dist`.
- **Корень:** для Vercel убрать subpath — в vite.config.ts сменить `base: '/SemeynoYeda/'` на `base: '/'`; в Router и PWA `start_url` убрать basename.
- Удалить или отключить `.github/workflows/deploy.yml` для GitHub Pages после переключения на Vercel.
- Переменные окружения задавать в Vercel (см. раздел 7).

---

## 3. База данных Supabase

- Создать проект на [supabase.com](https://supabase.com/).
- Таблицы в Postgres — зеркало текущей схемы Dexie (с учётом RLS при необходимости):

| Таблица            | Ключ               | Индексы / примечания                       |
| ------------------ | ------------------ | ------------------------------------------ |
| `recipes`          | `id` (PK)          | slug, category, tags (array), suitable_for |
| `menus`            | `id` (PK)          | week_start, created_at                     |
| `freezer`          | `id` (PK)          | recipe_id, expiry_date                     |
| `shopping`         | составной или `id` | ingredient, category, checked              |
| `prep_plans`       | `id` (PK)          | date                                       |
| `cooking_sessions` | `id` (PK)          | date, meal_type                            |
| `chef_settings`    | `id` (PK)          | —                                          |

- Имена колонок в snake_case для Postgres; в приложении — маппинг к текущим типам из `schema.ts`.
- Seed: один раз загрузить текущие рецепты и seed-меню (миграция или SQL/скрипт).

---

## 4. Закрытый доступ (только семья)

- **Supabase Auth, invite-only:** отключить публичную регистрацию; вход только по приглашению.
- Реализация:
  - В Supabase Dashboard: Auth → Providers → Email: включить Email; регистрацию закрыть (только инвайты).
  - Приглашения: через Dashboard (Auth → Users → Invite) или через Edge Function / админ-скрипт с `supabase.auth.admin.inviteUserByEmail()`.
  - В приложении: при незалогиненном пользователе — редирект на страницу входа; после входа — доступ ко всем страницам.
- RLS: политики на все таблицы с проверкой `auth.uid() IS NOT NULL`. При одной семье без разграничения по пользователям этого достаточно; при необходимости позже — `family_id`.

---

## 5. Offline-first и синхронизация

- **Цель:** работа без интернета по возможности; Supabase — источник истины при наличии сети.
- Подход:
  - Оставить Dexie и текущие таблицы в `src/lib/db.ts` как локальный кэш.
  - Слой синхронизации: при старте и по таймеру/событиям — чтение из Supabase в IndexedDB; локальные изменения — сначала в IndexedDB (optimistic), затем push в Supabase. При конфликтах — «last write wins» или по `updated_at`.
  - Инициализация: при доступном Supabase — подтянуть данные в IndexedDB; иначе — только из кэша; seed-рецепты по-прежнему мержить из initDb при первом запуске или при пустой БД.
- Зависимости: `@supabase/supabase-js`.

---

## 6. Интеграция с Notebook LM (ручная, через Google Drive)

- **Роль Notebook LM:** семейная база знаний по кухне; пользователь добавляет рецепты в базу через SemeynoYeda, затем вручную подключает источники в Notebook LM. Автоматической синхронизации между приложением и Notebook LM нет.
- **Поток:**
  - Рецепты и данные по морозилке из SemeynoYeda записываются в папку **«рецепты»** в Google Drive.
  - Файлы сохраняются в формате **Google Документов** (чтобы в Notebook LM можно было добавить источник из Drive).
  - Пользователь в Notebook LM нажимает «Добавить» и выбирает эту папку/документы.
- **Лимит 30 источников (Notebook LM):** архитектура выгрузки:
  - **Выбранный вариант:** один Google Doc с заголовками — все рецепты (и при необходимости блок «морозилка») как разделы документа; в ноутбук добавляется один источник, лимит 30 не упирается.
  - Альтернатива на будущее: несколько документов по категориям (соусы, основные, заготовки, морозилка), до 30 файлов.
  - Правила именования: `## Название рецепта`, метаданные (время, порции) в начале блока рецепта.
- **Реализация:** функция «Выгрузить в Google Drive» (или «Подготовить для Notebook LM»): формирование содержимого рецептов (+ опционально морозилка) и создание/обновление документа в папке «рецепты» через Google Drive API (OAuth, scope на Drive). Выгрузка по действию пользователя, без автосинхронизации.

---

## 6.1. Загрузка текстовых рецептов (очистка и разметка)

- **Цель:** добавлять рецепты в базу из сырого текста (сайт, мессенджер и т.д.); скрипты очищают от мусора и размечают структуру.
- **Функциональность:**
  - Экран «Добавить рецепт из текста»: поле ввода (textarea) для вставки текста.
  - Обработка: очистка от мусора (реклама, лишние переносы, служебные блоки), затем разметка полей:
    - **Название** рецепта
    - **Порядок приготовления** (шаги)
    - **Время приготовления** (и при возможности подготовка, порции)
  - Результат: предзаполненная форма редактирования рецепта; пользователь дополняет категорию, suitableFor, ингредиенты и сохраняет.
- **Реализация:** парсер на клиенте (или лёгкий backend/Edge Function), эвристики и регулярные выражения для типичных форматов; при необходимости — конфиг правил разметки (теги для времени и т.д.).
- **Связь с Notebook LM:** сохранённые рецепты можно выгружать в папку «рецепты» в Google Drive (раздел 6).

---

## 7. Переменные окружения

- В Vercel задать:
  - `VITE_SUPABASE_URL` — URL проекта Supabase.
  - `VITE_SUPABASE_ANON_KEY` — anon (public) key для клиента.
- Секреты (admin, service role) не использовать во фронтенде; инвайты и админ-операции — через Dashboard или Edge Functions.

---

## 8. Порядок внедрения (рекомендуемый)

1. Создать проект Supabase, схему таблиц и RLS.
2. Добавить Supabase client и Auth (экран логина, защита маршрутов).
3. Включить invite-only, пригласить тестовые email.
4. Реализовать синхронизацию Supabase ↔ IndexedDB (offline-first).
5. Перенести деплой на Vercel (`base: '/'`, env, отключить GitHub Pages workflow).
6. **Notebook LM:** экспорт рецептов (и при необходимости морозилки) в один Google Doc в папке «рецепты» в Google Drive; кнопка/экран «Выгрузить в Google Drive» с OAuth Google Drive API.
7. **Текстовые рецепты:** экран «Добавить рецепт из текста» → парсер (очистка, извлечение названия, шагов, времени) → предзаполненная форма рецепта → сохранение в базу.

---

## Ссылки

- [Supabase Auth](https://supabase.com/docs/guides/auth)
- [Vercel](https://vercel.com/docs)
- [Notebook LM](https://notebooklm.google/)
- [Google Drive API](https://developers.google.com/drive/api/guides/about-sdk)
