# Спецификация: Vercel, Neon PostgreSQL, закрытый доступ, Notebook LM

Цели: перенести деплой на Vercel, подключить базу Neon PostgreSQL с invite-only авторизацией (только для членов семьи), обеспечить offline-first синхронизацию; ручная интеграция с Notebook LM как семейной базой знаний через папку «рецепты» в Google Drive; возможность загрузки текстовых рецептов с очисткой и разметкой.

---

## 1. Текущее состояние архитектуры

### 1.1 Деплой
- **Платформа:** Vercel (serverless functions + static hosting)
- **Build:** `npm run build`, output directory `dist`
- **Base path:** `/` (убрано `base: '/SemeynoYeda/'` для Vercel)

### 1.2 База данных
- **Основная БД:** **Neon PostgreSQL** (serverless Postgres)
  - Connection: через `DATABASE_URL` environment variable
  - Клиент: `@neondatabase/serverless` в `api/_lib/db.ts`
  - Схема: `supabase/migrations/20250208000001_initial_schema.sql`
  - Seed скрипты: `scripts/seedNeon.ts` (используется для загрузки данных)

- **Локальный кэш:** Dexie (IndexedDB) — **НЕ ИСПОЛЬЗУЕТСЯ** в текущей реализации
  - Таблицы определены в `src/lib/db.ts`, но данные загружаются через API
  - Seed инициализация: `src/lib/initDb.ts` — синхронизирует seed-данные в IndexedDB (legacy)

### 1.3 API Layer
- **Vercel Serverless Functions:** папка `api/`
  - Главный endpoint: `api/data/[[...resource]].ts` — унифицированный REST API
  - Репозитории: `api/_lib/repositories/*.ts` — работа с Neon через SQL
  - Мапперы: `api/_lib/mappers.ts` — преобразование camelCase ↔ snake_case

### 1.4 Фронтенд
- **Data Service:** `src/lib/dataService.ts` — единая точка доступа к API
  - Все запросы идут через `dataService.recipes.list()`, `dataService.recipes.get(id)` и т.д.
  - API URL: `import.meta.env.VITE_API_URL` (по умолчанию пустая строка — относительные пути)

### 1.5 Авторизация
- **Текущий статус:** отсутствует (планируется Supabase Auth или Neon Auth)

---

## 1.6 Известные проблемы архитектуры

### Проблема 1: Потеря данных в JSONB полях (steps, ingredients)
**Симптомы:**
- Рецепты загружаются, но поле `steps` (процесс приготовления) пустое или отсутствует
- Маппинг между camelCase (app) и snake_case (DB) может неправильно обрабатывать JSONB поля

**Причина:**
- Маппер `dbToApp` в `api/_lib/mappers.ts` рекурсивно преобразует все объекты
- JSONB поля (`steps`, `ingredients`) приходят из PostgreSQL уже как объекты JavaScript
- При записи в БД JSONB поля сериализуются через `JSON.stringify()`, но при чтении могут теряться при маппинге

**Решение:**
- Проверить обработку JSONB полей в `recipeRepo.ts` — убедиться что они правильно парсятся из БД
- Возможно нужно исключить JSONB поля из рекурсивного маппинга или обрабатывать их отдельно

### Проблема 2: Маппинг внутренних ссылок
**Симптомы:**
- Не работают внутренние ссылки между рецептами (например, ссылки на связанные рецепты)

**Причина:**
- Возможно проблема в роутинге или в том, как формируются ссылки

### Проблема 3: Двойная архитектура данных
**Текущая ситуация:**
- Есть и Neon PostgreSQL (основная БД), и IndexedDB (legacy, не используется)
- `initDb.ts` пытается синхронизировать seed-данные в IndexedDB, но приложение использует API → Neon

**Рекомендация:**
- Убрать использование IndexedDB или реализовать полноценную синхронизацию Neon ↔ IndexedDB для offline-first

---

## 2. Деплой на Vercel

- Подключить репозиторий к Vercel (Vercel Dashboard → Import Project).
- **Build:** `npm run build`, output directory `dist`.
- **Корень:** для Vercel убрать subpath — в vite.config.ts сменить `base: '/SemeynoYeda/'` на `base: '/'`; в Router и PWA `start_url` убрать basename.
- Удалить или отключить `.github/workflows/deploy.yml` для GitHub Pages после переключения на Vercel.
- Переменные окружения задавать в Vercel (см. раздел 7).

---

## 3. База данных Neon PostgreSQL

### 3.1 Текущая реализация
- **Провайдер:** Neon Serverless PostgreSQL
- **Подключение:** через `DATABASE_URL` environment variable в Vercel
- **Клиент:** `@neondatabase/serverless` в `api/_lib/db.ts`
- **Схема:** определена в `supabase/migrations/20250208000001_initial_schema.sql`

### 3.2 Структура таблиц

| Таблица            | Ключ               | JSONB поля | Индексы / примечания                       |
| ------------------ | ------------------ | --------- | ------------------------------------------ |
| `recipes`          | `id` (PK)          | `ingredients`, `steps`, `storage`, `reheating` | slug, category, tags (array), suitable_for |
| `menus`            | `id` (PK)          | `days`, `shopping_settings` | week_start, created_at                     |
| `freezer`          | `id` (PK)          | `reheating` | recipe_id, expiry_date                     |
| `shopping`         | `id` (PK)          | —         | ingredient, category, checked              |
| `prep_plans`       | `id` (PK)          | `tasks`   | date                                       |
| `cooking_sessions` | `id` (PK)          | `timers`  | date, meal_type                            |
| `chef_settings`    | `id` (PK)          | —         | —                                          |

### 3.3 Маппинг данных
- **Имена колонок:** snake_case в PostgreSQL (например, `suitable_for`, `prep_time`)
- **App schema:** camelCase в TypeScript (`suitableFor`, `prepTime`)
- **Мапперы:** `api/_lib/mappers.ts` — функции `appToDb()` и `dbToApp()` для преобразования
- **JSONB поля:** сериализуются через `JSON.stringify()` при записи, парсятся автоматически при чтении через Neon

### 3.4 Seed данных
- **Скрипт:** `scripts/seedNeon.ts` — загружает seed-рецепты и меню в Neon
- **Запуск:** `npm run seed:neon` (требует `DATABASE_URL`)
- **Формат:** использует `appToDb()` для преобразования перед записью в БД

---

## 4. Закрытый доступ (только семья)

### 4.1 Планируемая реализация
- **Вариант 1: Neon Auth** (рекомендуется для Neon PostgreSQL)
  - Использовать `@neondatabase/auth` для аутентификации
  - Интеграция с Neon Data API для JWT-валидации
  - RLS политики на уровне PostgreSQL

- **Вариант 2: Supabase Auth** (альтернатива)
  - Использовать Supabase только для Auth, данные в Neon
  - Supabase Auth → JWT → проверка в Neon через RLS
  - Более сложная архитектура, но проверенное решение

### 4.2 Invite-only доступ
- Отключить публичную регистрацию
- Вход только по приглашению (invite links)
- В приложении: при незалогиненном пользователе — редирект на страницу входа
- После входа — доступ ко всем страницам

### 4.3 Row Level Security (RLS)
- Политики на все таблицы с проверкой `auth.uid() IS NOT NULL`
- При одной семье без разграничения по пользователям этого достаточно
- При необходимости позже — добавить `family_id` для мульти-семейной поддержки

---

## 5. Offline-first и синхронизация

### 5.1 Текущее состояние
- **Текущая реализация:** НЕТ offline-first — все данные загружаются через API из Neon
- **IndexedDB:** определен в `src/lib/db.ts`, но НЕ используется для runtime данных
- **initDb.ts:** синхронизирует только seed-данные в IndexedDB (legacy функциональность)

### 5.2 Планируемая архитектура offline-first
- **Цель:** работа без интернета по возможности; Neon PostgreSQL — источник истины при наличии сети.
- **Подход:**
  - Использовать Dexie (IndexedDB) как локальный кэш
  - Слой синхронизации:
    - При старте: чтение из Neon → IndexedDB (если есть сеть)
    - Локальные изменения: сначала в IndexedDB (optimistic), затем push в Neon
    - При конфликтах: «last write wins» или по `updated_at`
  - Инициализация:
    - При доступном Neon — подтянуть данные в IndexedDB
    - Иначе — только из IndexedDB кэша
    - Seed-рецепты мержить из `initDb.ts` при первом запуске или при пустой БД
- **Зависимости:** `@neondatabase/serverless` для API, `dexie` для локального кэша

---

## 6. Интеграция с Notebook LM (ручная, через Google Drive)

- **Роль Notebook LM:** семейная база знаний по кухне; пользователь добавляет рецепты в базу через SemeynoYeda, затем вручную подключает источники в Notebook LM. Автоматической синхронизации между приложением и Notebook LM нет.
- **Поток:**
  - Рецепты и данные по морозилке из SemeynoYeda записываются в папку **«рецепты»** в Google Drive.
  - Файлы сохраняются в формате **Google Документов** (чтобы в Notebook LM можно было добавить источник из Drive).
  - Пользователь в Notebook LM нажимает «Добавить» и выбирает эту папку/документы.
- **Лимит 30 источников (Notebook LM):** архитектура выгрузки:
  - **Выбранный вариант:** один Google Doc с заголовками — все рецепты (и при необходимости блок «морозилка») как разделы документа; в ноутбук добавляется один источник, лимит 30 не упирается.
  - Альтернатива на будущее: несколько документов по категориям (соусы, основные, заготовки, морозилка), до 30 файлов.
  - Правила именования: `## Название рецепта`, метаданные (время, порции) в начале блока рецепта.
- **Реализация:** функция «Выгрузить в Google Drive» (или «Подготовить для Notebook LM»): формирование содержимого рецептов (+ опционально морозилка) и создание/обновление документа в папке «рецепты» через Google Drive API (OAuth, scope на Drive). Выгрузка по действию пользователя, без автосинхронизации.

---

## 6.1. Загрузка текстовых рецептов (очистка и разметка)

- **Цель:** добавлять рецепты в базу из сырого текста (сайт, мессенджер и т.д.); скрипты очищают от мусора и размечают структуру.
- **Функциональность:**
  - Экран «Добавить рецепт из текста»: поле ввода (textarea) для вставки текста.
  - Обработка: очистка от мусора (реклама, лишние переносы, служебные блоки), затем разметка полей:
    - **Название** рецепта
    - **Порядок приготовления** (шаги)
    - **Время приготовления** (и при возможности подготовка, порции)
  - Результат: предзаполненная форма редактирования рецепта; пользователь дополняет категорию, suitableFor, ингредиенты и сохраняет.
- **Реализация:** парсер на клиенте (или лёгкий backend/Edge Function), эвристики и регулярные выражения для типичных форматов; при необходимости — конфиг правил разметки (теги для времени и т.д.).
- **Связь с Notebook LM:** сохранённые рецепты можно выгружать в папку «рецепты» в Google Drive (раздел 6).

---

## 7. Переменные окружения

### 7.1 Vercel Environment Variables
- **`DATABASE_URL`** (обязательно) — connection string для Neon PostgreSQL
  - Формат: `postgresql://user:password@host.tld/dbname?sslmode=require`
  - Используется в serverless functions (`api/_lib/db.ts`)
  - НЕ должен быть доступен во фронтенде (только в serverless functions)

- **`VITE_API_URL`** (опционально) — базовый URL для API endpoints
  - По умолчанию: пустая строка (относительные пути `/api/...`)
  - Используется в `src/lib/dataService.ts`
  - Если не задан, используется относительный путь

### 7.2 Будущие переменные (для Auth)
- **`VITE_NEON_AUTH_URL`** — URL Neon Auth (если используется Neon Auth)
- **`VITE_SUPABASE_URL`** и **`VITE_SUPABASE_ANON_KEY`** — если используется Supabase Auth

### 7.3 Секреты
- Секреты (admin keys, service role) НЕ использовать во фронтенде
- Инвайты и админ-операции — через Dashboard или Edge Functions

---

## 8. Порядок внедрения (рекомендуемый)

### 8.1 Критические исправления (приоритет 1)
1. **Исправить проблему с JSONB полями (steps, ingredients)**
   - Проверить обработку JSONB в `api/_lib/repositories/recipeRepo.ts`
   - Убедиться что JSONB поля правильно парсятся при чтении из БД
   - Возможно исключить JSONB поля из рекурсивного маппинга в `mappers.ts`

2. **Исправить маппинг внутренних ссылок**
   - Проверить как формируются ссылки на рецепты
   - Убедиться что роутинг работает корректно

3. **Проверить seed данных**
   - Убедиться что `scripts/seedNeon.ts` правильно сохраняет все поля включая `steps`
   - Проверить что данные в БД содержат полные рецепты с шагами

### 8.2 Дальнейшее развитие (приоритет 2)
4. Создать проект Neon PostgreSQL (если еще не создан), применить схему из миграций
5. Настроить `DATABASE_URL` в Vercel
6. Добавить Auth (Neon Auth или Supabase Auth) — экран логина, защита маршрутов
7. Включить invite-only, пригласить тестовые email
8. Реализовать синхронизацию Neon ↔ IndexedDB (offline-first)
9. **Notebook LM:** экспорт рецептов в Google Drive
10. **Текстовые рецепты:** экран «Добавить рецепт из текста» → парсер → сохранение в базу

---

## 9. Архитектурная схема

```
┌─────────────────────────────────────────────────────────────┐
│                    Фронтенд (React)                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  dataService.ts → API calls → /api/data/recipes      │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │ HTTP
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              Vercel Serverless Functions                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  api/data/[[...resource]].ts                         │  │
│  │  └─→ recipeRepo.ts → getDb() → Neon PostgreSQL     │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────┘
                           │ SQL (DATABASE_URL)
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              Neon PostgreSQL (Serverless)                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  recipes table (JSONB: steps, ingredients)          │  │
│  │  menus, freezer, shopping, prep_plans, etc.         │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              IndexedDB (Dexie) - Legacy/Unused               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  initDb.ts синхронизирует seed-данные                │  │
│  │  НО: runtime данные НЕ используются из IndexedDB    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Ссылки

- [Neon PostgreSQL](https://neon.tech/docs)
- [Neon Serverless Driver](https://neon.tech/docs/serverless/serverless-driver)
- [Neon Auth](https://neon.tech/docs/auth) (если используется)
- [Supabase Auth](https://supabase.com/docs/guides/auth) (альтернатива)
- [Vercel](https://vercel.com/docs)
- [Notebook LM](https://notebooklm.google/)
- [Google Drive API](https://developers.google.com/drive/api/guides/about-sdk)
