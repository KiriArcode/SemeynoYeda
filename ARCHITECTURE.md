# 🍳 SemeynoYeda — Семейный менеджмент еды

## 1. Обзор проекта

**SemeynoYeda** — PWA-приложение для управления семейным питанием с учётом индивидуальных диетических потребностей (гастрит, предпочтения по текстурам и соусам).

### Ключевые принципы
- **Offline-first** — работает без интернета (PWA + IndexedDB)
- **Seed + IndexedDB** — стартовые рецепты и меню в коде seed (`seedRecipes.ts`, `seedMenu.ts`); при запуске загружаются в IndexedDB. Runtime-данные только в IndexedDB. Экспорт в Git/JSON — отдельная функция (см. SPEC.md).
- **Cursor-friendly** — структура проекта оптимизирована для работы с Cursor IDE
- **Двухпользовательская модель** — каждое блюдо может иметь вариации для разных членов семьи

---

## 2. Архитектура

### 2.1 Стек технологий

| Слой | Технология | Почему |
|------|-----------|--------|
| Фреймворк | **React 18** + **TypeScript** | Компонентная модель, типизация данных рецептов |
| Сборка | **Vite 5** | Быстрый HMR, нативный PWA-плагин |
| Стили | **Tailwind CSS 3** + **CSS Variables** | Утилиты + кастомная тема |
| Роутинг | **React Router 6** | SPA навигация |
| Хранилище | **IndexedDB** (через Dexie.js) | Offline-данные, >50MB |
| PWA | **vite-plugin-pwa** (Workbox) | Service Worker, кэширование |
| Хостинг | **Vercel** или **GitHub Pages** | см. раздел «Деплой» и SPEC.md |
| Синхронизация | **Supabase** (целевой, по SPEC) / **GitHub API** (опционально) | Offline-first sync или коммит данных |

### 2.2 Структура проекта

Актуальный список страниц и компонентов — в [FEATURES.md](FEATURES.md).

```
SemeynoYeda/
├── .cursor/rules/              # Правила Cursor (design-system.mdc, parse-recipes.mdc)
├── public/
│   ├── icons/                  # PWA иконки
│   └── 404.html                # SPA fallback для роутинга
├── src/
│   ├── app/Router.tsx          # Маршруты и конфигурация роутера
│   ├── components/
│   │   ├── ui/                 # Modal, Toast, AlertBanner, index
│   │   ├── layout/             # PageShell, BottomNav, Breadcrumbs, ChefModeToggle
│   │   ├── menu/               # WeekOverview, MealSlot, SwapModal, WeekStats
│   │   ├── recipe/             # RecipeForm
│   │   ├── prep/               # PrepBlock, PrepTaskCard
│   │   ├── cooking/            # CookingSession, IngredientCheck, ParallelCooking
│   │   └── shopping/           # ShoppingSettings
│   ├── data/
│   │   ├── schema.ts           # TypeScript типы данных (единственный источник правды по схеме)
│   │   ├── seedRecipes.ts      # Seed-рецепты (bulkPut в IndexedDB при инициализации)
│   │   └── seedMenu.ts         # Seed-меню
│   ├── hooks/                  # useShoppingList, usePrepPlan, useBatchCooking, useCookingTimers, useFreezerAlerts, useIngredientAvailability, useToast
│   ├── lib/
│   │   ├── db.ts               # Dexie.js инстанс
│   │   └── initDb.ts           # Инициализация БД, syncSeedRecipes
│   ├── pages/                  # MenuPage, RecipesPage, RecipeDetailPage, RecipeEditPage, RecipeNewPage, ShoppingPage, FreezerPage, PrepPage, CookingPage, ChefSettingsPage
│   ├── styles/globals.css      # CSS переменные, базовые стили
│   └── main.tsx
├── scripts/                    # seedSupabase.ts и др.
├── cursorrules                 # Глобальные правила Cursor
├── index.html
├── vite.config.ts
├── tailwind.config.ts
├── tsconfig.json
├── package.json
└── README.md
```

### 2.3 Модель данных

**Источник правды:** все типы и интерфейсы определены в [src/data/schema.ts](src/data/schema.ts).

Кратко:
- **FamilyMember**: `kolya` | `kristina` | `both`
- **DietTag**: gastritis-safe, soft-texture, rich-feel, freezable, quick, prep-day, batch-cooking, overnight, packable, low-calorie, blanch-before-freeze
- **MealType**: breakfast, second_breakfast, lunch, snack, dinner, late_snack
- **Recipe**: полная структура с ingredients, steps, equipment, storage, reheating, version
- **MealSlot** (слот в меню): mealType + recipes[] с recipeId, forWhom, variation, usesFromFreezer, coffeeOnly
- **WeekMenu**, **MenuDay**: неделя и день с датами
- **ShoppingItem**: + source (auto|manual|missing), markedMissing, coveredByFreezer
- **FreezerItem**: + portionsRemaining, portionsOriginal, batchId, forWhom, reheating
- **PrepPlan**, **PrepTask**; **BatchPlan**, **BatchTask**; **CookingSession**, **CookingTimer**; **ChefModeSettings**

### 2.4 Потоки данных

```
┌─────────────────────────────────────────────────────────────┐
│                      DATA FLOW                              │
│                                                             │
│  ┌─────────────────┐     при старте      ┌──────────────┐   │
│  │ seedRecipes.ts  │  bulkPut (merge)    │  IndexedDB   │   │
│  │ seedMenu.ts     │───────────────────▶│  (Dexie)    │   │
│  └─────────────────┘                     └──────┬───────┘   │
│         │                                        │           │
│         │                                        │ read/write│
│         │                                        ▼           │
│         │                                 ┌──────────┐      │
│         │                                 │   UI     │      │
│         │                                 └──────────┘      │
│         │                                                       │
│  Экспорт (опционально): IndexedDB → JSON → Git / скачивание   │
│  Целевой вариант (SPEC): Supabase ↔ IndexedDB, offline-first  │
└─────────────────────────────────────────────────────────────┘
```

**Цикл работы:**
1. **Старт приложения** — initDb: открытие Dexie, syncSeedRecipes (bulkPut seed-рецептов и seed-меню; новые рецепты из git появляются при следующем запуске).
2. **Runtime** — все чтение и запись только в IndexedDB.
3. **Экспорт** — по желанию: генерация JSON из IndexedDB → коммит через GitHub API или скачивание (см. SPEC.md для целевого варианта с Supabase).

---

## 3. Экраны и навигация

### Мобильная навигация (bottom tabs)

```
┌────────┬─────────┬──────────┬──────────┐
│  🗓️   │  📖    │   🧊    │   🛒    │
│ Меню   │ Рецепты│ Морозилка│ Покупки  │
└────────┴─────────┴──────────┴──────────┘
```

### Экраны

| # | Экран | Путь | Описание |
|---|-------|------|----------|
| 1 | **Меню недели** | `/` | Горизонтальный скролл 7 дней, 4 приёма |
| 2 | **День** | `/day/:date` | Детальный вид дня: блюда по приёмам |
| 3 | **Замена блюда** | модал | Выбрать другое блюдо из рецептов |
| 4 | **Рецепты** | `/recipes` | Фильтр по категории + тегам |
| 5 | **Рецепт** | `/recipe/:id` | Карточка, ингредиенты, шаги |
| 6 | **Добавить рецепт** | `/recipe/new` | Форма + "заметка" (raw text) |
| 7 | **Редактировать** | `/recipe/:id/edit` | Редактирование рецепта |
| 8 | **Заготовки** | `/prep` | Чек-лист для выходного дня |
| 9 | **Морозилка** | `/freezer` | Инвентарь замороженного |
| 10 | **Список покупок** | `/shopping` | Агрегированный из меню недели |
| 11 | **Настройки** | `/settings` | Профили семьи, синхронизация |

---

## 4. Функции MVP

### ✅ MVP-1 (первый релиз)

| Функция | Описание |
|---------|----------|
| Просмотр меню на неделю | 7 дней × 4 приёма, с указанием "для кого" |
| Замена блюда в меню | Тап на слот → выбрать из рецептов |
| Каталог рецептов | Фильтр по категории, теги, поиск |
| Карточка рецепта | Ингредиенты, шаги, время, хранение |
| Добавление рецепта | Форма + поле "заметка" (raw text для Cursor) |
| Редактирование рецепта | Все поля рецепта |
| Рецепты заготовок и соусов | Отдельная секция с пометкой `prep-day` |
| PWA / Offline | Установка на телефон, работа без сети |

### ✅ MVP-2 (реализовано)

| Функция | Описание |
|---------|----------|
| **Список покупок** | Автогенерация из меню недели, группировка, чекбоксы |
| **Морозилка** | Трекинг: что заморожено, порции, сроки, алерты |
| **Чек-лист заготовок** | Таймеры, фазы, порядок действий (useBatchCooking, usePrepPlan) |
| **Режим повара** | Настройки в ChefSettingsPage, overlay при готовке |

### 🔜 Следующая итерация

| Функция | Описание |
|---------|----------|
| **Семейные профили** | Настройка диет-тегов для каждого члена на отдельной странице |

### 🚀 MVP-3 (развитие)

| Функция | Описание |
|---------|----------|
| **Генерация меню** | AI-подбор на основе остатков в морозилке |
| **История меню** | Архив прошлых недель |
| **Нутриенты** | Базовый расчёт КБЖУ |
| **Шаринг** | QR-код для второго пользователя |
| **Telegram-бот** | Уведомления: "Достань котлеты!", список покупок |

---

## 5. Фичи, которые стоит добавить (не учтены в запросе)

### 🛒 Список покупок (КРИТИЧНО для MVP)
Автоматическая агрегация ингредиентов из меню недели. Группировка по категориям (мясо, молочка, овощи). Чекбоксы для отметки купленного. Это **главная экономия времени** в реальном использовании.

### 🧊 Трекер морозилки
Что заморожено → сколько порций → когда истекает. Уведомления "осталось 2 порции котлет". Интеграция с меню: приложение знает, что можно запланировать без похода в магазин.

### ⏱️ Таймер заготовок
Для 4-часового выходного дня: пошаговый чек-лист с таймерами. Параллельные процессы (пока варится пюре — формуем котлеты). Визуальная шкала прогресса.

### 👤 Пометка "для кого"
Каждое блюдо в меню показывает: 🟢 Оба / 🔵 Коля / 🟡 Кристина. Фильтр "показать только мои блюда" — быстрый доступ к своему рациону.

### 📊 Статистика разнообразия
"На этой неделе курица 4 раза из 7" — предупреждение о монотонности. Баланс категорий: мясо / рыба / овощи.

### 🔄 Шаблоны недель
Сохранять удачные недели как шаблон. "Загрузить неделю 12" — быстрое планирование. Сезонные шаблоны (лето / зима).

### 📸 Фото блюд
Прикрепить фото к рецепту — помогает визуально выбирать при замене. Камера прямо из приложения (PWA camera API).

---

## 6. PWA конфигурация

### manifest.json
```json
{
  "name": "SemeynoYeda — Семейная еда",
  "short_name": "СемейноЕда",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#0B0E14",
  "theme_color": "#39FF14",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

### Service Worker стратегия
- **App shell** — Cache First (HTML, CSS, JS)
- **Данные (JSON)** — Stale While Revalidate
- **Изображения** — Cache First с лимитом 50MB

### Деплой

- **Текущий:** конфиг готов под Vercel (`base: '/'` в vite.config.ts). Деплой может быть на Vercel или GitHub Pages (см. DEPLOY.md, vercel.json).
- **Целевой (SPEC.md):** Vercel + Supabase, invite-only доступ, offline-first синхронизация. Подробности — в [SPEC.md](SPEC.md) и [DEPLOY.md](DEPLOY.md).

---

## 7. Синхронизация данных

### Вариант A: Ручной экспорт (MVP)
1. Пользователь нажимает "Экспорт"
2. Приложение генерирует JSON-файлы
3. Скачиваются как `.json`
4. Пользователь коммитит в репо

### Вариант B: GitHub API (MVP-2)
1. Пользователь авторизуется через Personal Access Token
2. Приложение коммитит изменения напрямую через GitHub REST API
3. Триггерится GitHub Actions → редеплой

```typescript
// lib/github.ts
async function commitToRepo(files: {path: string, content: string}[]) {
  const token = localStorage.getItem('github_token');
  // ... GitHub Contents API
}
```

### Вариант C: GitHub App + OAuth (MVP-3)
Полноценная OAuth авторизация, автоматическая синхронизация.

---

## 8. Кухонное оборудование и заготовки

### 8.1 Оборудование

| Оборудование | Для Коли (гастрит) | Для Кристины | Заготовки |
|---|---|---|---|
| **Пароварка** ♨️ | ⭐ Основной способ | Для нежных блюд | Готовить суфле |
| **Аэрогриль** 🌀 | ✅ Без масла, мягко | ✅ Хорошо | Котлеты без масла |
| **Духовка** 🫕 | ✅ С водяной баней | ⭐ Корочка, "богатый" вкус | Суфле, запеканки |
| **Электрогриль** 🥩 | ⚠️ Редко | ⭐ Корочка + сок | Не для заготовок |
| **Газовая плита** 🔥 | ✅ Варка, тушение | ✅ Универсально | Пюре, соусы, крупы |
| **Гриндер** ⚙️ | — | — | Фарш из мяса/рыбы |
| **Планетарный миксер** 🎛️ | — | — | Вымес фарша, взбивание |
| **Блендер** 🫙 | — | — | Все пюре и соусы |
| **Вакууматор** 📦 | — | — | Порционная заморозка |

### 8.2 Workflow заготовок (4 часа в выходной)

```
Час 1: ФАРШ
┌─────────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│ Нарезать    │──▶│ Гриндер  │──▶│ Миксер   │──▶│ Формовка │
│ мясо кусками│   │ ⚙️ фарш  │   │ 🎛️ вымес │   │ 🥣 миски │
│ 10 мин      │   │ 10 мин   │   │ 5 мин    │   │ 20 мин   │
└─────────────┘   └──────────┘   └──────────┘   └────┬─────┘
                                                      │
                                         ┌────────────┤
                                         ▼            ▼
                                   Котлеты (20шт) Фрикадельки (30шт)

Час 2: ПАРАЛЛЕЛЬНО
┌──────────────────┐        ┌───────────────────────┐
│ Плита 🔥         │        │ Духовка 🫕             │
│ Варить лук 10мин │        │ Рыбное суфле          │
│ Варить овощи     │        │ 170°C 30 мин          │
│ для пюре 20 мин  │        │                       │
└────────┬─────────┘        └───────────┬───────────┘
         ▼                              ▼
  Блендер 🫙                     Остудить
  Пюре + соусы                   ▼

Час 3: ПЮРЕ И СОУСЫ
┌──────────────────┐
│ Блендер 🫙       │
│ Картофельное пюре│
│ Кабачковое пюре  │
│ Морковно-тыкв.   │
│ Кабачковый соус  │
│ Сырный соус      │
└────────┬─────────┘
         ▼

Час 4: УПАКОВКА
┌──────────────────┐   ┌──────────────┐
│ Порционировать   │──▶│ Вакууматор 📦│──▶ Морозилка ❄️
│ по 2 порции      │   │ + подписать  │
│ 🥣 миски         │   │ дату + назв. │
└──────────────────┘   └──────────────┘
```

### 8.3 Способы приготовления замороженного (будни, 15-30 мин)

| Заготовка | Коля (щадяще) | Кристина (вкусно) |
|---|---|---|
| Котлеты (заморож.) | Пароварка ♨️ 25 мин | Электрогриль 🥩 7+7 мин |
| Котлеты (заморож.) | Аэрогриль 🌀 180°C 20 мин | Духовка 🫕 200°C 25 мин |
| Суфле (заморож.) | Пароварка ♨️ 15 мин | Духовка 🫕 170°C 15 мин |
| Фрикадельки | Пароварка ♨️ 20 мин | Духовка 🫕 190°C 20 мин |
| Пюре (заморож.) | Плита 🔥 разогрев 5 мин | Плита 🔥 разогрев 5 мин |
| Соус (заморож.) | Плита 🔥 разогрев 3 мин | Плита 🔥 разогрев 3 мин |
