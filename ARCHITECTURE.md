# 🍳 SemeynoYeda — Семейный менеджмент еды

## 1. Обзор проекта

**SemeynoYeda** — PWA-приложение для управления семейным питанием с учётом индивидуальных диетических потребностей (гастрит, предпочтения по текстурам и соусам).

### Ключевые принципы
- **Offline-first** — работает без интернета (PWA + IndexedDB как локальный кэш)
- **Neon PostgreSQL + IndexedDB** — основная БД — Neon (serverless Postgres), доступ через Vercel Serverless Functions. IndexedDB (Dexie) используется как offline-кэш и синхронизируется с Neon через `syncService.ts`. Seed-данные (57 рецептов, меню) загружаются при старте.
- **Cursor-friendly** — структура проекта оптимизирована для работы с Cursor IDE
- **Двухпользовательская модель** — каждое блюдо может иметь вариации для разных членов семьи

---

## 2. Архитектура

### 2.1 Стек технологий

| Слой | Технология | Почему |
|------|-----------|--------|
| Фреймворк | **React 18** + **TypeScript** | Компонентная модель, типизация данных рецептов |
| Сборка | **Vite 5** | Быстрый HMR, нативный PWA-плагин |
| Стили | **Tailwind CSS 4** (через @tailwindcss/vite) + **CSS Variables** | Утилиты + кастомная тема |
| Роутинг | **React Router 6** | SPA навигация |
| Хранилище | **Neon PostgreSQL** (serverless) + **IndexedDB** (Dexie, offline-кэш) | Основная БД в облаке, локальный кэш для offline |
| API | **Vercel Serverless Functions** (`api/`) | REST-доступ к Neon из клиента |
| PWA | **vite-plugin-pwa** (Workbox) | Service Worker, кэширование |
| Хостинг | **Vercel** | Serverless Functions + статика |
| Синхронизация | **Neon ↔ IndexedDB** через syncService (offline-first) | Фоновая синхронизация, optimistic writes |

### 2.2 Структура проекта

Актуальный список страниц и компонентов — в [FEATURES.md](FEATURES.md).

```
SemeynoYeda/
├── .cursor/rules/              # Правила Cursor (design-system.mdc, parse-recipes.mdc)
├── public/
│   ├── icons/                  # PWA иконки
│   └── 404.html                # SPA fallback для роутинга
├── src/
│   ├── app/Router.tsx          # Маршруты и конфигурация роутера
│   ├── components/
│   │   ├── ui/                 # Modal, Toast, AlertBanner, index
│   │   ├── layout/             # PageShell, BottomNav, Breadcrumbs, ChefModeToggle
│   │   ├── menu/               # WeekOverview, MealSlot, SwapModal, WeekStats
│   │   ├── recipe/             # RecipeForm
│   │   ├── prep/               # PrepBlock, PrepTaskCard
│   │   ├── cooking/            # CookingSession, IngredientCheck, ParallelCooking
│   │   └── shopping/           # ShoppingSettings
│   ├── data/
│   │   ├── schema.ts           # TypeScript типы данных (единственный источник правды по схеме)
│   │   ├── seedRecipes.ts      # 57 seed-рецептов (bulkPut в IndexedDB при инициализации)
│   │   └── seedMenu.ts         # Seed-меню
│   ├── hooks/                  # useShoppingList, usePrepPlan, useBatchCooking, useCookingTimers, useFreezerAlerts, useIngredientAvailability, useToast
│   ├── lib/
│   │   ├── db.ts               # Dexie.js инстанс (локальный кэш)
│   │   ├── initDb.ts           # Инициализация БД, syncSeedRecipes
│   │   ├── dataService.ts      # Локальный data-сервис (IndexedDB)
│   │   ├── dataServiceApi.ts   # API data-сервис (Neon через Vercel Functions)
│   │   ├── dataServiceWithSync.ts # Комбинированный сервис: API + IndexedDB кэш
│   │   └── syncService.ts      # Синхронизация Neon ↔ IndexedDB (фоновый sync)
│   ├── pages/                  # MenuPage, RecipesPage, RecipeDetailPage, RecipeEditPage, RecipeNewPage, ShoppingPage, FreezerPage, PrepPage, CookingPage, ChefSettingsPage
│   ├── styles/globals.css      # CSS переменные, базовые стили
│   └── main.tsx
├── api/
│   ├── _lib/                   # db.ts (Neon), mappers.ts, repositories/
│   ├── data/
│   │   └── [[...resource]].ts # Единый REST endpoint для всех ресурсов
│   ├── shopping/
│   │   └── [[...slug]].ts     # Shopping endpoint (специфичная логика)
│   └── prep-plans/
│       └── [[...slug]].ts     # Prep plans endpoint (специфичная логика)
├── scripts/                    # seedDb.ts, seedNeon.ts, checkDb.ts, testDbConnection.ts
├── cursorrules                 # Глобальные правила Cursor
├── index.html
├── vite.config.ts
├── tailwind.config.ts
├── tsconfig.json
├── package.json
└── README.md
```

### 2.3 Модель данных

**Источник правды:** все типы и интерфейсы определены в [src/data/schema.ts](src/data/schema.ts).

Кратко:
- **FamilyMember**: `kolya` | `kristina` | `both`
- **DietTag**: gastritis-safe, soft-texture, rich-feel, freezable, quick, prep-day, batch-cooking, overnight, packable, low-calorie, blanch-before-freeze
- **MealType**: breakfast, second_breakfast, lunch, snack, dinner, late_snack
- **Recipe**: полная структура с ingredients, steps, equipment, storage, reheating, version
- **MealSlot** (слот в меню): mealType + recipes[] с recipeId, forWhom, variation, usesFromFreezer, coffeeOnly
- **WeekMenu**, **MenuDay**: неделя и день с датами
- **ShoppingItem**: + source (auto|manual|missing), markedMissing, coveredByFreezer
- **FreezerItem**: + portionsRemaining, portionsOriginal, batchId, forWhom, reheating
- **PrepPlan**, **PrepTask**; **BatchPlan**, **BatchTask**; **CookingSession**, **CookingTimer**; **ChefModeSettings**

### 2.4 Потоки данных

```
┌───────────────────────────────────────────────────────────────────┐
│                         DATA FLOW                                 │
│                                                                   │
│  ┌──────────────┐  seed при старте  ┌──────────────┐             │
│  │seedRecipes.ts│──────────────────▶│  IndexedDB   │             │
│  │ seedMenu.ts  │  (57 рецептов)    │  (Dexie)     │             │
│  └──────────────┘                   │  offline-кэш │             │
│                                     └──────┬───────┘             │
│                                       ▲    │                     │
│                            sync       │    │ fast read           │
│                          (background) │    ▼                     │
│  ┌──────────────────┐            ┌──────────┐                    │
│  │  Neon PostgreSQL │◀──────────▶│   UI     │                    │
│  │  (primary DB)    │  write     └──────────┘                    │
│  └────────┬─────────┘  (optimistic → push)                       │
│           │                                                       │
│           │ SQL                                                   │
│           ▼                                                       │
│  ┌──────────────────┐                                            │
│  │ Vercel Serverless│  REST API (api/)                           │
│  │ Functions        │  dataServiceApi.ts → Neon                  │
│  └──────────────────┘                                            │
│                                                                   │
│  syncService.ts: фоновая синхронизация Neon ↔ IndexedDB          │
│  dataServiceWithSync.ts: единый интерфейс для UI                 │
└───────────────────────────────────────────────────────────────────┘
```

**Цикл работы:**
1. **Старт приложения** — initDb: открытие Dexie, syncSeedRecipes (bulkPut 57 seed-рецептов и seed-меню). Запуск фоновой синхронизации с Neon.
2. **Чтение** — UI читает из IndexedDB (быстро, offline-доступ). В фоне syncService подтягивает актуальные данные из Neon.
3. **Запись** — optimistic write в IndexedDB (UI обновляется мгновенно), затем push в Neon через API. При конфликте — last write wins.
4. **Фоновый sync** — syncService.ts периодически синхронизирует Neon ↔ IndexedDB (каждые 30с при наличии сети).

---

## 3. Экраны и навигация

### Мобильная навигация (bottom tabs)

```
┌────────┬─────────┬──────────┬──────────┐
│  🗓️   │  📖    │   🧊    │   🛒    │
│ Меню   │ Рецепты│ Морозилка│ Покупки  │
└────────┴─────────┴──────────┴──────────┘
```

### Экраны

| # | Экран | Путь | Описание |
|---|-------|------|----------|
| 1 | **Меню недели** | `/` | Горизонтальный скролл 7 дней, 4 приёма |
| 2 | **День** | `/day/:date` | Детальный вид дня: блюда по приёмам |
| 3 | **Замена блюда** | модал | Выбрать другое блюдо из рецептов |
| 4 | **Рецепты** | `/recipes` | Фильтр по категории + тегам |
| 5 | **Рецепт** | `/recipe/:id` | Карточка, ингредиенты, шаги |
| 6 | **Добавить рецепт** | `/recipe/new` | Форма + "заметка" (raw text) |
| 7 | **Редактировать** | `/recipe/:id/edit` | Редактирование рецепта |
| 8 | **Заготовки** | `/prep` | Чек-лист для выходного дня |
| 9 | **Морозилка** | `/freezer` | Инвентарь замороженного |
| 10 | **Список покупок** | `/shopping` | Агрегированный из меню недели |
| 11 | **Настройки** | `/settings` | Профили семьи, синхронизация |

---

## 4. Функции MVP

### ✅ MVP-1 (первый релиз)

| Функция | Описание |
|---------|----------|
| Просмотр меню на неделю | 7 дней × 4 приёма, с указанием "для кого" |
| Замена блюда в меню | Тап на слот → выбрать из рецептов |
| Каталог рецептов | Фильтр по категории, теги, поиск |
| Карточка рецепта | Ингредиенты, шаги, время, хранение |
| Добавление рецепта | Форма + поле "заметка" (raw text для Cursor) |
| Редактирование рецепта | Все поля рецепта |
| Рецепты заготовок и соусов | Отдельная секция с пометкой `prep-day` |
| PWA / Offline | Установка на телефон, работа без сети |

### ✅ MVP-2 (реализовано)

| Функция | Описание |
|---------|----------|
| **Список покупок** | Автогенерация из меню недели, группировка, чекбоксы |
| **Морозилка** | Трекинг: что заморожено, порции, сроки, алерты |
| **Чек-лист заготовок** | Таймеры, фазы, порядок действий (useBatchCooking, usePrepPlan) |
| **Режим повара** | Настройки в ChefSettingsPage, overlay при готовке |

### 🔜 Следующая итерация

| Функция | Описание |
|---------|----------|
| **Семейные профили** | Настройка диет-тегов для каждого члена на отдельной странице |

### 🚀 MVP-3 (развитие)

| Функция | Описание |
|---------|----------|
| **Генерация меню** | AI-подбор на основе остатков в морозилке |
| **История меню** | Архив прошлых недель |
| **Нутриенты** | Базовый расчёт КБЖУ |
| **Шаринг** | QR-код для второго пользователя |
| **Telegram-бот** | Уведомления: "Достань котлеты!", список покупок |

---

## 5. Фичи, которые стоит добавить (не учтены в запросе)

### 🛒 Список покупок (КРИТИЧНО для MVP)
Автоматическая агрегация ингредиентов из меню недели. Группировка по категориям (мясо, молочка, овощи). Чекбоксы для отметки купленного. Это **главная экономия времени** в реальном использовании.

### 🧊 Трекер морозилки
Что заморожено → сколько порций → когда истекает. Уведомления "осталось 2 порции котлет". Интеграция с меню: приложение знает, что можно запланировать без похода в магазин.

### ⏱️ Таймер заготовок
Для 4-часового выходного дня: пошаговый чек-лист с таймерами. Параллельные процессы (пока варится пюре — формуем котлеты). Визуальная шкала прогресса.

### 👤 Пометка "для кого"
Каждое блюдо в меню показывает: 🟢 Оба / 🔵 Коля / 🟡 Кристина. Фильтр "показать только мои блюда" — быстрый доступ к своему рациону.

### 📊 Статистика разнообразия
"На этой неделе курица 4 раза из 7" — предупреждение о монотонности. Баланс категорий: мясо / рыба / овощи.

### 🔄 Шаблоны недель
Сохранять удачные недели как шаблон. "Загрузить неделю 12" — быстрое планирование. Сезонные шаблоны (лето / зима).

### 📸 Фото блюд
Прикрепить фото к рецепту — помогает визуально выбирать при замене. Камера прямо из приложения (PWA camera API).

---

## 6. PWA конфигурация

### manifest.json
```json
{
  "name": "SemeynoYeda — Семейная еда",
  "short_name": "СемейноЕда",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#0B0E14",
  "theme_color": "#39FF14",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
```

### Service Worker стратегия
- **App shell** — Cache First (HTML, CSS, JS)
- **Данные (JSON)** — Stale While Revalidate
- **Изображения** — Cache First с лимитом 50MB

### Деплой

- **Платформа:** Vercel (`base: '/'` в vite.config.ts, конфиг в `vercel.json`).
- **Serverless Functions:** каталог `api/` — автоматически деплоятся как Vercel Serverless Functions, обеспечивают REST-доступ к Neon PostgreSQL.
- **БД:** Neon PostgreSQL (serverless) — подключение через `DATABASE_URL` в переменных окружения Vercel.
- **Offline:** PWA + IndexedDB обеспечивают работу без сети; при восстановлении соединения syncService синхронизирует данные с Neon.

---

## 7. Синхронизация данных

### Архитектура: Neon ↔ IndexedDB (offline-first)

Синхронизация реализована в `syncService.ts` и `dataServiceWithSync.ts`.

**Компоненты:**
- **`dataServiceWithSync.ts`** — единый интерфейс для UI. Комбинирует чтение из IndexedDB (быстрый ответ) с фоновым обновлением из Neon.
- **`dataServiceApi.ts`** — REST-клиент для Vercel Serverless Functions → Neon PostgreSQL.
- **`dataService.ts`** — локальный data-сервис, работает с IndexedDB (Dexie).
- **`syncService.ts`** — фоновая синхронизация между Neon и IndexedDB.

**Принцип работы:**

```
┌────────────┐   optimistic write   ┌──────────────┐   push   ┌─────────────────┐
│    UI      │─────────────────────▶│  IndexedDB   │────────▶│ Neon PostgreSQL  │
│            │◀─────────────────────│  (Dexie)     │◀────────│ (через API)      │
│            │     fast read        │  offline-кэш │  pull   │ primary DB       │
└────────────┘                      └──────────────┘         └─────────────────┘
```

**Процесс синхронизации:**
1. **Запись** — данные сначала записываются в IndexedDB (optimistic update, UI обновляется мгновенно), затем отправляются в Neon через API.
2. **Чтение** — UI читает из IndexedDB для мгновенного отклика. В фоне syncService подтягивает свежие данные из Neon.
3. **Фоновый sync** — syncService запускает периодическую синхронизацию каждые 30 секунд при наличии сети.
4. **Конфликты** — разрешение по принципу «last write wins» (последняя запись побеждает).
5. **Offline** — при отсутствии сети приложение работает полностью на IndexedDB. При восстановлении соединения накопленные изменения отправляются в Neon.

---

## 8. Кухонное оборудование и заготовки

### 8.1 Оборудование

| Оборудование | Для Коли (гастрит) | Для Кристины | Заготовки |
|---|---|---|---|
| **Пароварка** ♨️ | ⭐ Основной способ | Для нежных блюд | Готовить суфле |
| **Аэрогриль** 🌀 | ✅ Без масла, мягко | ✅ Хорошо | Котлеты без масла |
| **Духовка** 🫕 | ✅ С водяной баней | ⭐ Корочка, "богатый" вкус | Суфле, запеканки |
| **Электрогриль** 🥩 | ⚠️ Редко | ⭐ Корочка + сок | Не для заготовок |
| **Газовая плита** 🔥 | ✅ Варка, тушение | ✅ Универсально | Пюре, соусы, крупы |
| **Гриндер** ⚙️ | — | — | Фарш из мяса/рыбы |
| **Планетарный миксер** 🎛️ | — | — | Вымес фарша, взбивание |
| **Блендер** 🫙 | — | — | Все пюре и соусы |
| **Вакууматор** 📦 | — | — | Порционная заморозка |

### 8.2 Workflow заготовок (4 часа в выходной)

```
Час 1: ФАРШ
┌─────────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│ Нарезать    │──▶│ Гриндер  │──▶│ Миксер   │──▶│ Формовка │
│ мясо кусками│   │ ⚙️ фарш  │   │ 🎛️ вымес │   │ 🥣 миски │
│ 10 мин      │   │ 10 мин   │   │ 5 мин    │   │ 20 мин   │
└─────────────┘   └──────────┘   └──────────┘   └────┬─────┘
                                                      │
                                         ┌────────────┤
                                         ▼            ▼
                                   Котлеты (20шт) Фрикадельки (30шт)

Час 2: ПАРАЛЛЕЛЬНО
┌──────────────────┐        ┌───────────────────────┐
│ Плита 🔥         │        │ Духовка 🫕             │
│ Варить лук 10мин │        │ Рыбное суфле          │
│ Варить овощи     │        │ 170°C 30 мин          │
│ для пюре 20 мин  │        │                       │
└────────┬─────────┘        └───────────┬───────────┘
         ▼                              ▼
  Блендер 🫙                     Остудить
  Пюре + соусы                   ▼

Час 3: ПЮРЕ И СОУСЫ
┌──────────────────┐
│ Блендер 🫙       │
│ Картофельное пюре│
│ Кабачковое пюре  │
│ Морковно-тыкв.   │
│ Кабачковый соус  │
│ Сырный соус      │
└────────┬─────────┘
         ▼

Час 4: УПАКОВКА
┌──────────────────┐   ┌──────────────┐
│ Порционировать   │──▶│ Вакууматор 📦│──▶ Морозилка ❄️
│ по 2 порции      │   │ + подписать  │
│ 🥣 миски         │   │ дату + назв. │
└──────────────────┘   └──────────────┘
```

### 8.3 Способы приготовления замороженного (будни, 15-30 мин)

| Заготовка | Коля (щадяще) | Кристина (вкусно) |
|---|---|---|
| Котлеты (заморож.) | Пароварка ♨️ 25 мин | Электрогриль 🥩 7+7 мин |
| Котлеты (заморож.) | Аэрогриль 🌀 180°C 20 мин | Духовка 🫕 200°C 25 мин |
| Суфле (заморож.) | Пароварка ♨️ 15 мин | Духовка 🫕 170°C 15 мин |
| Фрикадельки | Пароварка ♨️ 20 мин | Духовка 🫕 190°C 20 мин |
| Пюре (заморож.) | Плита 🔥 разогрев 5 мин | Плита 🔥 разогрев 5 мин |
| Соус (заморож.) | Плита 🔥 разогрев 3 мин | Плита 🔥 разогрев 3 мин |
