# –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –ø—Ä–æ–±–ª–µ–º

## –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Neon PostgreSQL** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î (serverless Postgres)
- Connection —á–µ—Ä–µ–∑ `DATABASE_URL` –≤ Vercel
- –ö–ª–∏–µ–Ω—Ç: `@neondatabase/serverless` –≤ `api/_lib/db.ts`

### API Layer
- **Vercel Serverless Functions** –≤ –ø–∞–ø–∫–µ `api/`
- –ì–ª–∞–≤–Ω—ã–π endpoint: `api/data/[[...resource]].ts`
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: `api/_lib/repositories/*.ts`
- –ú–∞–ø–ø–µ—Ä—ã: `api/_lib/mappers.ts` (camelCase ‚Üî snake_case)

### –§—Ä–æ–Ω—Ç–µ–Ω–¥
- **Data Service**: `src/lib/dataService.ts` ‚Äî –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ API
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ `dataService.recipes.list()`, `dataService.recipes.get(id)`

### IndexedDB (Legacy)
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ `src/lib/db.ts`, –Ω–æ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –¥–ª—è runtime –¥–∞–Ω–Ω—ã—Ö
- `initDb.ts` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ seed-–¥–∞–Ω–Ω—ã–µ (legacy —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)

---

## –ü—Ä–æ–±–ª–µ–º–∞ 1: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –≤ JSONB –ø–æ–ª—è—Ö (steps, ingredients)

### –°–∏–º–ø—Ç–æ–º—ã
- –†–µ—Ü–µ–ø—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –Ω–æ –ø–æ–ª–µ `steps` (–ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è) –ø—É—Å—Ç–æ–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- –ü–æ–ª–µ `ingredients` –º–æ–∂–µ—Ç —Ç–∞–∫–∂–µ —Ç–µ—Ä—è—Ç—å—Å—è

### –ê–Ω–∞–ª–∏–∑

#### –ö–∞–∫ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
1. –í `recipeRepo.ts` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:
   ```typescript
   ingredients = ${JSON.stringify(db.ingredients ?? [])}::jsonb,
   steps = ${JSON.stringify(db.steps ?? [])}::jsonb,
   ```
   - –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `appToDb()` (camelCase ‚Üí snake_case)
   - JSONB –ø–æ–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `JSON.stringify()`
   - –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î –∫–∞–∫ JSONB

#### –ö–∞–∫ –¥–∞–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è
1. –í `recipeRepo.ts` –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏:
   ```typescript
   const rows = await sql`SELECT * FROM recipes ...`;
   return result.map((r) => dbToApp<Recipe>(r as Record<string, unknown>));
   ```
   - Neon –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç JSONB –ø–æ–ª—è –≤ –æ–±—ä–µ–∫—Ç—ã JavaScript
   - –ú–∞–ø–ø–µ—Ä `dbToApp()` –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç snake_case ‚Üí camelCase
   - **–ü—Ä–æ–±–ª–µ–º–∞**: –º–∞–ø–ø–µ—Ä —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã, –≤–∫–ª—é—á–∞—è JSONB –ø–æ–ª—è

#### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

**–í–∞—Ä–∏–∞–Ω—Ç 1: JSONB –ø–æ–ª—è –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏**
- Neon –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å JSONB –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç—ã
- –ù—É–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å –≤—Ä—É—á–Ω—É—é: `JSON.parse(row.steps)`

**–í–∞—Ä–∏–∞–Ω—Ç 2: –ú–∞–ø–ø–µ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã**
- JSONB –ø–æ–ª—è —É–∂–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (camelCase), –Ω–æ –º–∞–ø–ø–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∏—Ö –µ—â–µ —Ä–∞–∑
- –ù—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å JSONB –ø–æ–ª—è –∏–∑ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç 3: JSONB –ø–æ–ª—è —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –º–∞–ø–ø–∏–Ω–≥–µ**
- –ú–∞–ø–ø–µ—Ä –º–æ–∂–µ—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å JSONB –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ù—É–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å JSONB –ø–æ–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ

### –†–µ—à–µ–Ω–∏–µ

#### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Neon
–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `recipeRepo.ts`:
```typescript
const rows = await sql`SELECT * FROM recipes ...`;
console.log('[DEBUG] Raw row from DB:', {
  steps: rows[0]?.steps,
  stepsType: typeof rows[0]?.steps,
  stepsIsArray: Array.isArray(rows[0]?.steps),
});
```

#### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É JSONB –ø–æ–ª–µ–π
–ï—Å–ª–∏ JSONB –ø–æ–ª—è –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏:
```typescript
// –í recipeRepo.ts –ø–µ—Ä–µ–¥ –º–∞–ø–ø–∏–Ω–≥–æ–º
const parsedRow = {
  ...row,
  steps: typeof row.steps === 'string' ? JSON.parse(row.steps) : row.steps,
  ingredients: typeof row.ingredients === 'string' ? JSON.parse(row.ingredients) : row.ingredients,
};
```

–ï—Å–ª–∏ JSONB –ø–æ–ª—è —É–∂–µ –æ–±—ä–µ–∫—Ç—ã, –Ω–æ –º–∞–ø–ø–µ—Ä –∏—Ö –ø–æ—Ä—Ç–∏—Ç:
```typescript
// –í mappers.ts - –∏—Å–∫–ª—é—á–∏—Ç—å JSONB –ø–æ–ª—è –∏–∑ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
const JSONB_FIELDS = ['steps', 'ingredients', 'storage', 'reheating', 'days', 'tasks', 'timers'];

function mapKeys(obj: Record<string, unknown>, fn: (s: string) => string, excludeFields: string[] = []): Record<string, unknown> {
  if (obj === null || typeof obj !== 'object') return obj;
  const result: Record<string, unknown> = {};
  for (const [k, v] of Object.entries(obj)) {
    const newKey = fn(k);
    // –ù–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSONB –ø–æ–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
    if (excludeFields.includes(k)) {
      result[newKey] = v;
    } else if (Array.isArray(v) && v[0] && typeof v[0] === 'object' && !Array.isArray(v[0])) {
      result[newKey] = v.map((item) => mapKeys(item as Record<string, unknown>, fn, excludeFields));
    } else if (typeof v === 'object' && v !== null && !Array.isArray(v) && !(v instanceof Date)) {
      result[newKey] = mapKeys(v as Record<string, unknown>, fn, excludeFields);
    } else {
      result[newKey] = v;
    }
  }
  return result;
}
```

---

## –ü—Ä–æ–±–ª–µ–º–∞ 2: –ú–∞–ø–ø–∏–Ω–≥ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Å—ã–ª–æ–∫

### –°–∏–º–ø—Ç–æ–º—ã
- –ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –º–µ–∂–¥—É —Ä–µ—Ü–µ–ø—Ç–∞–º–∏

### –ê–Ω–∞–ª–∏–∑
- –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —Å—Å—ã–ª–∫–∏ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ä–æ—É—Ç–∏–Ω–≥–µ –∏–ª–∏ –≤ —Ç–æ–º, –∫–∞–∫ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è URL

### –†–µ—à–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞—é—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–µ—Ü–µ–ø—Ç—ã
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: `/recipe/${recipe.id}` –∏–ª–∏ `/recipe/${recipe.slug}`

---

## –ü—Ä–æ–±–ª–µ–º–∞ 3: –î–≤–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
- –ï—Å—Ç—å –∏ Neon PostgreSQL (–æ—Å–Ω–æ–≤–Ω–∞—è –ë–î), –∏ IndexedDB (legacy, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- `initDb.ts` –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å seed-–¥–∞–Ω–Ω—ã–µ –≤ IndexedDB, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API ‚Üí Neon

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–í–∞—Ä–∏–∞–Ω—Ç A: –£–±—Ä–∞—Ç—å IndexedDB –ø–æ–ª–Ω–æ—Å—Ç—å—é**
   - –£–¥–∞–ª–∏—Ç—å `src/lib/db.ts` –∏ `src/lib/initDb.ts`
   - –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ API ‚Üí Neon

2. **–í–∞—Ä–∏–∞–Ω—Ç B: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IndexedDB –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å Neon ‚Üî IndexedDB –¥–ª—è offline-first
   - –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –Ω–æ –ª—É—á—à–µ UX

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å SPEC.md —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
2. üî≤ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å JSONB –ø–æ–ª—è–º–∏ (steps, ingredients)
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É JSONB –≤ `recipeRepo.ts` –∏–ª–∏ `mappers.ts`
3. üî≤ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å—Å—ã–ª–æ–∫
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å —Å—Å—ã–ª–∫–∞–º–∏
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–æ—É—Ç–∏–Ω–≥ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
4. üî≤ –†–µ—à–∏—Ç—å —Å—É–¥—å–±—É IndexedDB
   - –õ–∏–±–æ —É–±—Ä–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
   - –õ–∏–±–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
5. üî≤ –î–æ–±–∞–≤–∏—Ç—å Auth (Neon Auth –∏–ª–∏ Supabase Auth)
6. üî≤ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å offline-first —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (–µ—Å–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º IndexedDB)

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

–î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å:
```sql
SELECT 
  id, 
  title, 
  steps, 
  jsonb_typeof(steps) as steps_type,
  ingredients,
  jsonb_typeof(ingredients) as ingredients_type
FROM recipes 
LIMIT 5;
```

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç:
- –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ JSONB –ø–æ–ª—è—Ö
- –ö–∞–∫–æ–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç PostgreSQL (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'array' –∏–ª–∏ 'object')
