# Уроки и методология отладки

Документ фиксирует выводы по инциденту с невидимыми модалками (RecipesPage: «Импорт», «AI Промпт») и даёт рекомендации, как эффективнее находить причину проблемы и искать способы решения.

**См. также:**

- [TROUBLESHOOTING.md](../TROUBLESHOOTING.md) — разбор конкретных ошибок (API, база, деплой).
- [DEVTOOLS_AND_SELF_WORK.md](DEVTOOLS_AND_SELF_WORK.md) — работа в DevTools, определение элементов, чек-лист перед правкой UI.
- [MODAL_ARCHITECTURE_FIX.md](MODAL_ARCHITECTURE_FIX.md) — возможные причины невидимости модалок и диагностика (SwapModal, портал, z-index).

---

## 1. Уроки по кейсу «модалки не показываются»

### Состояние не равно видимости

В консоли логи показывали `showImportModal: true` и `showAIPromptGenerator: true` — клики доходили, `setState` срабатывал. После удаления отладочного лога «Modal rendering» возникло ощущение, что модалки «не загружаются». На деле проблема была не в рендере, а в **отображении**: узел портала появлялся в DOM, но не был виден из‑за слоёв и CSS.

Вывод: не путать «state обновился» с «модалка показалась». Если state в порядке, следующий шаг — проверить DOM и стили.

### Разделять слои диагностики

Имеет смысл проверять цепочку по шагам:

1. **Клик и state** — доходит ли событие до кнопки, обновляется ли состояние (логи, React DevTools).
2. **Рендер** — вызывается ли компонент модалки с `isOpen={true}`, доходит ли выполнение до `createPortal` (точечный лог или React DevTools).
3. **DOM** — появляется ли ожидаемый узел в документе (DevTools → Elements, поиск по `#modal-root` или по контейнеру портала).
4. **CSS** — если узел есть, но не виден: z-index, stacking context, overflow, не перекрывает ли другой слой.

В нашем случае сбой был на уровне (4): портал рендерился, но оказывался под другими слоями или не выигрывал по z-index.

### Z-index и билд

Класс Tailwind `z-[2147483647]` на оверлее модалки мог по-разному вести себя в dev и в билде (preview/prod); кроме того, тот же z-index был у `PortalTransitionOverlay` в [PortalTransitionContext.tsx](../src/contexts/PortalTransitionContext.tsx), из‑за чего порядок слоёв был неочевидным.

**Решение:** вынести контейнер модалок в отдельный узел и задать z-index в **обычном CSS**, а не через Tailwind. В [globals.css](../src/styles/globals.css) для `#modal-root` заданы `position: fixed`, `inset: 0`, `z-index: 2147483647`; портал рендерится в этот узел ([Modal.tsx](../src/components/ui/Modal.tsx), [index.html](../index.html)). Так мы не зависим от того, попал ли произвольный класс Tailwind в итоговый CSS.

### Portal target

Рендер в `document.body` корректен, но выделенный [index.html](../index.html) узел `#modal-root` даёт предсказуемый stacking context и единое место для стилей. В Elements можно в любой момент проверить, что портал действительно монтируется в `#modal-root`.

### Дизайн-система

Временное исправление через `style={{ zIndex: ... }}` в [Modal.tsx](../src/components/ui/Modal.tsx) нарушило правило «без inline-стилей». Замена на Tailwind-класс убрала нарушение, но сама по себе не решила видимость. Итоговое решение (отдельный контейнер и стили для `#modal-root` в [globals.css](../src/styles/globals.css)) и правилу соответствует, и проблему решает.

---

## 2. Как эффективнее находить проблему

### Уточнить симптом

Зафиксировать: что именно не так (не открывается, не видно, не реагирует на клик) и в каком окружении (dev, preview, prod). Это помогает не смешивать разные причины (например, «не видно» из‑за CSS и «не открывается» из‑за того, что клик не доходит).

### Проверить цепочку по шагам

1. **Событие**
   - Доходит ли клик до нужного элемента: DevTools → Elements → Inspect при клике (или выбор элемента и клик по кнопке).
   - Не перехватывает ли событие родитель: вкладка Event Listeners у элемента и его родителей.
   - Подробнее: [DEVTOOLS_AND_SELF_WORK.md](DEVTOOLS_AND_SELF_WORK.md).

2. **State**
   - Обновляется ли состояние после действия: временный лог в обработчике или React DevTools (Components → выбранный компонент → hooks/state).
   - Если state не меняется — искать причину в обработчике, в размонтировании компонента или в том, что клик попадает не в тот элемент.

3. **Рендер**
   - Вызывается ли компонент (например, модалки) с нужными пропсами (`isOpen={true}`) и доходит ли выполнение до портала/условного рендера: точечный лог внутри компонента или React DevTools (дерево компонентов, пропсы).

4. **DOM**
   - Появляется ли ожидаемый узел в документе: Elements, поиск по id/классу/родителю (например, `#modal-root`, контейнер портала).
   - Если узла нет — проблема до портала (условие рендера, размонтирование).

5. **CSS**
   - Если узел есть, но не виден: вкладка Computed — `z-index`, `visibility`, `opacity`, `display`.
   - Проверить родительские stacking context: `transform`, `filter`, `opacity`, `isolation`, `overflow`.
   - Убедиться, что другой слой (другой fixed/sticky элемент с высоким z-index) не перекрывает наш.

### Сужать место сбоя

По результатам определить, на каком шаге цепочка рвётся (событие → state → render → DOM → CSS), и дальше копать только там. Не тратить время на гипотезы про «модалка не рендерится», если в DOM узел уже есть и проблема в стилях.

---

## 3. Как искать способы решения

### Формулировать запрос узко

Вместо общего «modal not showing» искать, например: «react createPortal modal not visible z-index», «modal portal behind overlay stacking context», «fixed element not visible tailwind build». Узкие запросы чаще дают релевантные ответы.

### Использовать несколько источников

- Stack Overflow — типичные кейсы с порталами, z-index, stacking context.
- Официальная документация (React: Portals, Composition).
- GitHub issues: reactjs/react.dev, facebook/react — по ключевым словам (portal, z-index, modal).

### Проверять среду и версии

Решение для другой версии React, другого бандлера или другого способа задавать стили может не подойти. При применении чужого фикса учитывать наш стек: Vite, Tailwind v4, портал в `#modal-root` / body.

### Фиксировать результат

Если найденное решение сработало — кратко записать в [TROUBLESHOOTING.md](../TROUBLESHOOTING.md) или в docs (как в этом документе), чтобы не повторять поиск в следующий раз.
